<div ng-controller="configredemption" style="margin:20px; ">
    <div ng-if="mypermission.id==-1">
        <h2>Tài khoản của bạn chưa đủ quyền truy cập chức năng này</h2>
    </div>
    <div ng-show="mypermission.id!=-1">
    <!-- Modal -->
    <div  class="modal fade" id="callfees" role="dialog">
        <div class="modal-dialog" style="width:90%;">
          <!-- Modal content-->
          <div class="modal-content" style="width:100%;">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal">&times;</button>
              <h4 class="modal-title">Tính khấu trừ Redemption
              </h4>
            </div>
            <div class="modal-body" >
                <form name="callredemptionForm">
                    <div class="row">
                        <div class="form-group col-md-4">
                            <label>Loại phương tiện</label>
                            <select required ensure-expression="demo.vehicleselected.id!=-1"  ng-model="demo.vehicleselected" class="form-control"
                                                    ng-options="it as it.name for it in demo.vehicles"></select>
                        </div>
                        <div class="form-group col-md-4">
                            <label>Thời điểm check-in:</label>
                            <div style="padding:0" class="form-control">
                                <input  style="height:34px;border:solid 1px #cdcdcd; border-top-left-radius:3px;border-bottom-left-radius:3px;"  type="date" class="col-md-7" placeholder="dd-MM-yyyy HH:mm:ss"
                                      required ng-model="demo.checkindate">
                                <input style="height:34px;border:solid 1px #cdcdcd; border-top-right-radius:3px;border-bottom-right-radius:3px;"  name="timestart" value="[[addsample.timestart]]" pattern="([0-1]?[0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])" placeholder="HH:mm:ss" class="col-md-5"
                                  required ng-model="demo.checkintime">
                            </div>
                        </div>
                        <div class="form-group col-md-4">
                            <label>Thời điểm khấu trừ:</label>
                            <div style="padding:0" class="form-control">
                                <input  style="height:34px;border:solid 1px #cdcdcd; border-top-left-radius:3px;border-bottom-left-radius:3px;"  type="date" class="col-md-7" placeholder="dd-MM-yyyy HH:mm:ss"
                                      required ng-model="demo.redemptiondate">
                                <input style="height:34px;border:solid 1px #cdcdcd; border-top-right-radius:3px;border-bottom-right-radius:3px;"  name="timestart" value="[[addsample.timestart]]" pattern="([0-1]?[0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])" placeholder="HH:mm:ss" class="col-md-5"
                                  required ng-model="demo.redemptiontime">
                            </div>
                        </div>
                        <div class="form-group col-md-12">
                            <table class="grid table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Nhóm cửa hàng
                                            <button ng-disabled="groupselected.id==-1" type="button" class="btn btn-info btn-sm" ng-click="adgrouptenant()" >
                                                <span class="glyphicon glyphicon-plus"></span>
                                            </button>
                                            <button type="button" class="btn btn-danger btn-sm" ng-click="delgrouptenant()">
                                                <span class="glyphicon glyphicon-remove"></span>
                                            </button>
                                        </th>
                                        <th>Số tiền Bill</th>
                                    </tr>
                                    <tr>
                                        <th colspan="100%">
                                            <select   ng-model="groupselected" class="form-control"
                                                    ng-options="it as it.groupname for it in groups"></select>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="item in addgroups">
                                        <td>
                                            [[item.group.groupname]]
                                        </td>
                                        <td>
                                            <div class="col-md-5">
                                                <input pattern="^[0-9]*$" ensure-expression="checkmoney(item.billamount)" type="text" class="form-control" placeholder="Số tiền bill"
                                                 ng-model="item.billamount">
                                            </div>

                                            <strong class="col-md-7 text-info" style="font-size:large" >
                                                [[(item.billamount | number:0)]]<span style="font-size:x-small;vertical-align: text-top;">đ</span>
                                            </strong>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="form-group col-md-12">
                           <button style="width:120px;" type="submit" ng-click="postcallredemtion()" class="btn btn-success btn-block"
                               ng-disabled="callredemptionForm.$invalid ||callredemptionForm.$error.pattern">
                                Tính khấu trừ
                            </button>
                        </div>

                    </div>
                </form>

            </div>
            <div class="modal-footer">

                <table class="grid table table-bordered">
                    <thead>
                        <tr>
                            <th colspan="100%">
                                Mức khấu trừ ([[callresult.details[0].details[0].redemtiontime]]):
                                <strong class="text-info" style="font-size:large" >
                                    [[(callresult.redemtionresult | number:0)]]<span style="font-size:x-small;vertical-align: text-top;">đ</span>
                                </strong>
                            </th>
                        </tr>
                        <tr>
                            <th>Nhóm cửa hàng</th>
                            <th>Mẫu phí</th>
                            <th>Tiền bill</th>
                            <th>Tiền khấu trừ</th>
                            <th>Công thức</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="item in callresult.details">
                            <td>[[item.groupname]]</td>
                            <td>[[item.callname]]</td>
                            <td>[[(item.details[0].billamount| number:0)]]<span style="font-size:x-small;vertical-align: text-top;">đ</span></td>
                            <td>[[(item.details[0].deductionamount| number:0)]]<span style="font-size:x-small;vertical-align: text-top;">đ</span></td>
                            <td>
                                <div ng-mouseover="item.showdetailf=true" ng-mouseout="item.showdetailf=false">
                                    <span  class="form-control" style="cursor:pointer;">
                                        [[item.details[0].formula[0].callname]]
                                    </span>
                                    <div style="position:absolute;z-index:999" ng-show="item.showdetailf">
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Mức hóa đơn</th>
                                                    <th>Khấu trừ</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr ng-repeat="dt in item.details[0].formula[0].detail">
                                                    <td>
                                                        <span ng-if="$first || $middle">[[(dt.billamount | number:0)]]<span style="font-size:x-small;vertical-align: text-top;">đ</span></span>
                                                        <span ng-if="$last &&$last !=$first">Từ  [[(dt.billamount | number:0)]]<span style="font-size:x-small;vertical-align: text-top;">đ</span> trỏ lên</span>
                                                    </td>
                                                    <td class="text-info">[[(dt.deductionamount | number:0)]]<span style="font-size:x-small;vertical-align: text-top;">đ</span></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
          </div>
        </div>
      </div>
        <div ng-if="mypermission.isadd">
            <table class="grid table table-bordered">
                <thead>
                    <tr>
                        <th>
                            Chọn nhiều nhóm cửa hàng</th>
                        <th>Chọn nhiều loại xe</th>
                    </tr>
                <tr>
                    <td colspan="100%">
                        <div ng-repeat="item in redemptregissimilar.groups">
                            <label for="chkslsml[[item.id]]">
                                <input value="[[item.chosen]]" type="checkbox" id="chkslsml[[item.id]]" ng-model="item.chosen"/>
                                [[item.name]]
                            </label>
                            <div  style="padding-left:25px; background-color:#2ecc71;color:black;" ng-show="item.chosen">
                                <label for="chkslsmlvt[[item.id]][[vt.id]]" ng-repeat="vt in item.vehicles">
                                    <input values="[[vt.chosen]]" type="checkbox" id="chkslsmlvt[[item.id]][[vt.id]]" ng-model="vt.chosen"/>
                                    [[vt.name]]
                                </label>
                            </div>
                        </div>
                    </td>
                </tr>
                </thead>
                <tbody>
                    <tr ng-if="item.chosen" ng-repeat="item in redemptregissimilar.groups">
                        <td>[[item.name]]</td>
                        <td>
                            <span ng-if="vt.chosen" ng-repeat="vt in item.vehicles">
                                [[vt.name]],
                            </span>
                        </td>
                    </tr>
                </tbody>
                <tfoot style="margin:0px">
                    <tr style="margin:0px" >
                        <td style="margin:0px; padding:0px;" colspan="100%" >
                            <form name="sampleregisformsimilar">
                                <table style="margin:0px" class="grid table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Áp dụng công thức khấu trừ phí</th>
                                            <th>Ngày hiệu lực</th>
                                            <th>#</th>
                                        </tr>
                                        <tr>
                                            <th>
                                                <!--<select required ng-init="redemptregissimilar.sample.sampleselected=redemptregissimilar.sample.samples[0]" ensure-expression="redemptregissimilar.sample.sampleselected.id!=-1"  ng-model="redemptregissimilar.sample.sampleselected" class="form-control"-->
                                                    <!--ng-options="it as it.callname for it in redemptregissimilar.sample.samples"></select>-->
                                                <div ng-click="redemptregissimilar.sample.samples.fiterformula='';redemptregissimilar.sample.samples.showlistfolmurla=!redemptregissimilar.sample.samples.showlistfolmurla;">
                                                    <span ng-style="redemptregissimilar.sample.sampleselected.id === -1 && {'background-color': 'orange'}||redemptregissimilar.sample.sampleselected.id !== -1 && {'background-color': 'green'}"
                                                            ng-init="redemptregissimilar.sample.sampleselected=redemptregissimilar.sample.samples[0]" class="form-control" style="cursor:pointer;;color:black;">
                                                        [[redemptregissimilar.sample.sampleselected.callname]]
                                                    </span>
                                                </div>
                                                <ul ng-mouseover="redemptregissimilar.sample.samples.showlistfolmurla=true;"  ng-mouseout="redemptregissimilar.sample.samples.showlistfolmurla=false;" class="fomurla" style="position:absolute;z-index:9999;" ng-show="redemptregissimilar.sample.samples.showlistfolmurla">
                                                    <li><input class="form-control"  type="text" ng-change="filterformular(redemptregissimilar.sample.samples);"  ng-model="redemptregissimilar.sample.samples.fiterformula" placeholder="Lọc" style="background-color:#fff;" class="form-control" /> </li>
                                                    <li ng-show="(redemptregissimilar.sample.samples.fiterformula=='' || it.canshow)"  style="background-color:#2ecc71;" ng-repeat="it in redemptregissimilar.sample.samples" ng-click="redemptregissimilar.sample.sampleselected=redemptregissimilar.sample.samples[$index];redemptregissimilar.sample.samples.showlistfolmurla=false;" >
                                                            [[it.callname]]
                                                    </li>
                                                </ul>

                                            </th>
                                            <th>
                                                <input type="date" class="form-control" placeholder="dd-MM-yyyy"
                                                  required ng-model="item.activedate">
                                            </th>

                                            <th colspan="3">
                                                 <img ng-show="loadingaddsimilar" class="loading-inner" src="/static/image/loading.gif">
                                                <button type="submit" ng-click="post_sampleregissimilar(item)" class="btn btn-success btn-block"
                                                    ng-disabled="sampleregisformsimilar.$invalid ||sampleregisformsimilar.$error.pattern||redemptregissimilar.sample.sampleselected.id==-1" >
                                                    Lưu
                                                </button>
                                            </th>
                                        </tr>
                                    </thead>
                                </table>
                            </form>
                        </td>
                    </tr>
                </tfoot>
            </table>

        </div>
    <table class="grid table table-bordered">
        <thead>
            <tr>
                <th>
                    <button title="Tính khấu trừ redemption"  ng-click="calculate(it,item);" type="button" class="btn btn-info btn-sm" data-toggle="modal" data-target="#callfees">
                                        <span class="glyphicon glyphicon-eur"></span>
                    </button>
                    Nhóm cửa hàng
                </th>
                <th>Loại phương tiện</th>
            </tr>
        </thead>
        <tbody>
            <tr ng-repeat-start = "item in groupactive">
                <td>
                    <div style="cursor:pointer;" ng-mouseover="item.showdetail=!item.showdetailconfig;getdetail(item);" ng-mouseout="item.showdetail=false;">
                        <span ng-click="item.showdetailconfig=true;getdetailconfig(item);" ng-hide="item.showdetailconfig" style="cursor:pointer;" class="glyphicon glyphicon-plus"></span>
                        <span ng-click="item.showdetailconfig=false;" ng-hide="!item.showdetailconfig" style="cursor:pointer;"  class="glyphicon glyphicon-minus"></span>
                        <span ng-mouseover="item.showdetail=true;getdetail(item);" ng-mouseout="item.showdetail=false;">[[item.groupname]]</span>
                        <div ng-show="item.showdetail" style="position:absolute;z-index:999">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Cửa hàng
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="dt in item.detail">
                                        <td>[[dt.tenant]]</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                    </div>
                </td>
                <td>
                    [[item.vehiclename]]
                </td>
            </tr>
            <tr ng-repeat-end ng-show="item.showdetailconfig">
                <td colspan="100%">
                    <div >
                            <form name="sampleregisform">
                                <table class="table table-bordered" >
                                    <thead>
                                        <tr>
                                            <th>Công thức khấu trừ</th>
                                            <!--<th title="Dùng khi thời điểm Redemption không cùng ngày thời điểm check-in">Mẫu phí 1</th>-->
                                            <th>Ngày hiệu lực</th>
                                            <th>Ngày kết thúc</th>
                                            <th>Người tạo</th>
                                            <th>#</th>
                                        </tr>
                                        <tr ng-if="mypermission.isadd">
                                            <th>
                                                <!--<select required ensure-expression="item.activesamples.samples.sampleselected.id!=-1"  ng-model="item.activesamples.samples.sampleselected" class="form-control"-->
                                                    <!--ng-options="it as it.callname for it in item.activesamples.samples.samples"></select>-->
                                                 <div ng-click="item.activesamples.samples.samples.fiterformula='';item.activesamples.samples.samples.showlistfolmurla=!item.activesamples.samples.samples.showlistfolmurla;">
                                                    <span ng-style="item.activesamples.samples.sampleselected.id === -1 && {'background-color': 'orange'}||item.activesamples.samples.sampleselected.id !== -1 && {'background-color': 'green'}"
                                                            ng-init="item.activesamples.samples.sampleselected=item.activesamples.samples.samples[0]" class="form-control" style="cursor:pointer;color:black;">
                                                        [[item.activesamples.samples.sampleselected.callname]]
                                                    </span>
                                                </div>
                                                <ul ng-mouseover="item.activesamples.samples.samples.showlistfolmurla=true;"  ng-mouseout="item.activesamples.samples.samples.showlistfolmurla=false;" class="fomurla" style="position:absolute;z-index:9999;" ng-show="item.activesamples.samples.samples.showlistfolmurla">
                                                    <li><input class="form-control"  type="text" ng-change="filterformular(item.activesamples.samples.samples);"  ng-model="item.activesamples.samples.samples.fiterformula" placeholder="Lọc" style="background-color:#fff;" class="form-control" /> </li>
                                                    <li ng-show="(item.activesamples.samples.samples.fiterformula=='' || it.canshow)"  style="background-color:#2ecc71;" ng-repeat="it in item.activesamples.samples.samples" ng-click="item.activesamples.samples.sampleselected=item.activesamples.samples.samples[$index];item.activesamples.samples.samples.showlistfolmurla=false;" >
                                                            [[it.callname]]
                                                    </li>
                                                </ul>
                                            </th>
                                            <!--<th ng-if="false" title="Dùng khi thời điểm Redemption không cùng ngày thời điểm check-in">-->
                                                <!--<select required ensure-expression="item.activesamples.samples.sampleselected1.id!=-1"  ng-model="item.activesamples.samples.sampleselected1" class="form-control"-->
                                                    <!--ng-options="it as it.callname for it in item.activesamples.samples.samples"></select>-->
                                            <!--</th>-->
                                            <th>
                                                <input type="date" class="form-control" placeholder="dd-MM-yyyy"
                                                  required ng-model="item.activesamples.samples.activedate">
                                            </th>
                                            <th colspan="3">
                                                <button type="submit" ng-click="post_redemtionregis(item)" class="btn btn-success btn-block"
                                                    ng-disabled="sampleregisform.$invalid ||sampleregisform.$error.pattern || item.activesamples.samples.sampleselected.id==-1" >
                                                    Lưu
                                                </button>

                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr ng-repeat="it in item.activesamples.redemption">
                                           <td ng-if="$first" style="background-color:green;color:white;">
                                                [[it.samplename]]
                                            </td>
                                            <!--<td ng-if="false" style="background-color:green;color:white;">-->
                                                <!--[[it.samplename1]]-->
                                            <!--</td>-->
                                            <td ng-if="$first" style="background-color:green;color:white;">
                                                [[it.activedate]]
                                            </td>
                                            <td ng-if="$first" style="background-color:green;color:white;">
                                                [[it.expireddate]]
                                            </td>
                                            <td ng-if="$first" style="background-color:green;color:white;">
                                                [[it.usercreated]]
                                            </td>
                                            <td ng-if="!$first" >
                                                [[it.samplename]]
                                            </td>
                                            <!--<td ng-if="!$first" >-->
                                                <!--[[it.samplename1]]-->
                                            <!--</td>-->
                                            <td ng-if="!$first" >
                                                [[it.activedate]]
                                            </td>
                                            <td ng-if="!$first" >
                                                [[it.expireddate]]
                                            </td>
                                            <td ng-if="!$first" >
                                                [[it.usercreated]]
                                            </td>
                                             <td>
                                                <button title="xóa" ng-click="removeitem(it,item,$index)" ng-if="it.ischange && (mypermission.isdelall || (mypermission.isdel && mypermission.userid==it.userid));" type="button" class="btn btn-danger btn-sm" >
                                                    <span class="glyphicon glyphicon-remove"></span>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </form>
                        </div>
                </td>
            </tr>
        </tbody>
    </table>
    </div>
</div>