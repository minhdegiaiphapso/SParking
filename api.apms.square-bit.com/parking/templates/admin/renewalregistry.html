<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

</body>
</html>{% extends "admin/base.html" %}
{% block title %}
| Tìm đăng ký xe
{% endblock %}

{% block branding %}
<h1 id="site-name" xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html"
    xmlns="http://www.w3.org/1999/html" >
</h1>
{% endblock %}

{% block extrahead %}

<link rel="stylesheet" type="text/css" href="/static/css/page.css"/>
<link rel="stylesheet" type="text/css" href="/static/css/bootstrap.min.css">
<!--datetimepicker-->
<link rel="stylesheet" type="text/css" href="/static/css/jquery.datetimepicker.css"/>
<link rel="stylesheet" type="text/css" href="/static/css/jquery.dataTables.min.css"/>
<link rel="stylesheet" type="text/css" href="/static/css/1.8.18/jquery-ui.css" media="all"/>
<style>
    .grey{
        background-color:#cdcdcd;
    }
    .bbtt {
      width:100%;
      background-color:green;
      height:40px;
      padding:5px;
      position: fixed;
      bottom: 0px;
      margin-right: auto;
      margin-left: auto;
    }
    .loading{
        position: fixed;
        left:45%;
        top:45%;
        display:none;
    }
</style>
{% endblock %}

{% block content %}
<div class="containerRPS">
    <img src="/static/image/loading.gif" height="64px;" class="loading"/>
    <h2>Thêm danh sách gia hạn</h2>
    <form method="post" id="formRPS">
        {% csrf_token %}
        <div class="row" style="background-color:#f1f1f1; overflow-y:auto;">
            <div class="col-md-3 col-sm-6 form-group" >
                <label>Khách hàng:
                    <a href="/admin/parking/customer/add/" class="add-another" target="_blank" onclick="return showAddAnotherPopup(this);">
                        <img src="/static/admin/img/icon_addlink.gif" alt="Add">
                    </a>
                </label>
                <input type="text" value="{{cusname}}" readonly="readonly" id="txtCustomer" name="customer" class="form-control"/>
                <input type="hidden" value="{{cusid}}" id="hdfCus"/>
                <input type="hidden" value="{{current_user}}" id="hdfUser"/>
            </div>
            <div class="col-md-3 col-sm-6 form-group">
                <label>
                    Thanh toán:
                </label>
                <div class="form-control">
                    <input type="radio" id="paymentmethod1" checked="checked"
                        name="paymentmethod" value="TM"/>
                    <label for="paymentmethod1">Tiền mặt</label>
                    <input type="radio" id="paymentmethod2"
                     name="paymentmethod" value="CK"/>
                    <label for="paymentmethod2">Chuyển khoản</label>
                </div>

            </div>
            <div class="col-md-3 col-sm-6 form-group">
                <label>Ghi chú:</label>
                <input type="text" id="txtNote" name="note" class="form-control"/>
            </div>
            <div class="col-md-3 col-sm-6 form-group">
                <label>Tổng số tiền:
                </label>
                <input class="form-control" type="text" style="color:red;font-weight: bold;font-size:large;" readonly="readonly" value="0" name="totalfee" id="txttotalfee"/>
            </div>
        </div>

        <hr/>
        <div>

            <h2>Chi tiết thanh toán vé tháng</h2>
            <table class="grid">
                <thead>
                <tr>
                    <th><input class="cc grey" id="chkall" value="All" type="checkbox" onchange="allcheck();"/>
                     <!--<label for="chkall">Chọn</label></th>-->
                    <th>Biển số xe
                         <input class="form-control cc grey" id="txtBSX" onkeyup="search();" type="text"/>
                    </th>
                    <th>Số thẻ
                         <input class="form-control cc grey" id="txtST" onkeyup="search();" onchange="changeFee(this);" type="text"/>
                    </th>
                    <th>Loại xe</th>
                    <th>Trình trạng</th>
                    <th>Ngày hiệu lực
                        <input style="overflow: hidden;" class="form-control activedate cc grey" id="txtActiveDate" onchange="changeall1(this);" value="{{re.activedate}}" type="text"/>
                    </th>
                    <th>Số tháng
                        <select class="form-control cc grey" onchange="changeall2(this);" id="slMonth">
                            <option value="0">0 tháng</option>
                            <option value="30">1 tháng</option>
                            <option value="60">2 tháng</option>
                            <option value="90">3 tháng</option>
                            <option value="120">4 tháng</option>
                            <option value="150">5 tháng</option>
                            <option value="180">6 tháng</option>
                            <option value="210">7 tháng</option>
                            <option value="240">8 tháng</option>
                            <option value="270">9 tháng</option>
                            <option value="300">10 tháng</option>
                            <option value="330">11 tháng</option>
                            <option value="360">1 năm</option>
                        </select>
                    </th>
                    <th>Số ngày cộng thêm
                         <input class="form-control cc grey number" id="txtDay" onchange="changeall3(this);" value="0" type="text"/>
                    </th>
                    <th>Hạn cũ
                    </th>
                    <th>Hạn mới</th>
                    <th>Phí tháng</th>
                    <th>thành tiền</th>
                </tr>
                </thead>
                <tbody class="myBody">
                     {%if registations%}
                        {%for re in registations%}
                            <tr class="cc grey">
                                <td>
                                    <input class="cc grey" type="checkbox" onchange="changeFee(this);"/>
                                    <input type="hidden" value="{{re.id}}"/>
                                </td>
                                <td>{{re.vehicelnumber}}</td>
                                <td>{{re.cardnumber}}</td>
                                <td>{{re.vehicletype}}</td>
                                <td>{{re.status}}</td>
                                <td>
                                    <input style="overflow: hidden;" class="form-control activedate cc grey" onchange="changeDate(this);changeFee(this);" value="{{re.activedate}}" type="text"/>
                                <td>
                                    <select class="form-control cc grey" onchange="changeFee(this);">
                                        <option value="0">0 tháng</option>
                                        <option value="30">1 tháng</option>
                                        <option value="60">2 tháng</option>
                                        <option value="90">3 tháng</option>
                                        <option value="120">4 tháng</option>
                                        <option value="150">5 tháng</option>
                                        <option value="180">6 tháng</option>
                                        <option value="210">7 tháng</option>
                                        <option value="240">8 tháng</option>
                                        <option value="270">9 tháng</option>
                                        <option value="300">10 tháng</option>
                                        <option value="330">11 tháng</option>
                                        <option value="360">1 năm</option>
                                    </select>
                                </td>
                                <td>
                                    <input class="form-control cc grey number" onchange="changeFee(this);" value="0" type="text"/>
                                </td>
                                <td><input readonly="readonly" value="{{re.expireddate}}" class="form-control cc grey" type="text"/></td>
                                <td><input readonly="readonlyy" class="form-control cc grey" type="text"></td>
                                <td><input readonly="readonly" class="form-control cc grey" value="{{re.feepermonth}}" type="text"></td>
                                <td><input style="color:red;font-weight: bold;font-size:large;" readonly="readonly" class="form-control cc grey" value="0" type="text"></td>
                            </tr>
                        {%endfor%}
                    {%endif%}
                </tbody>
            </table>
        </div>
        <div class="btn-group bbtt">
            <button  class="btn btn-primary" type="submit" name="btn_save" id="txtAjax">Gia hạn</button>
        </div>
     </form>
</div>


<script src="/static/jquery/1.8.16/jquery-ui.min.js" type="text/javascript"></script>
<script src="/static/jquery/jquery.min.js" type="text/javascript"></script>


<script src="/static/jquery/jquery.js"></script>
<script src="/static/jquery/jquery.dataTables.min.js"></script>

<script src="/static/jquery/jquery.min.js" type="text/javascript"></script>
<script src="/static/jquery/1.8.16/jquery-ui.min.js" type="text/javascript"></script>

<!--script for datimepicker-->
<script src="/static/jquery/jquery.js"></script>
<script src="/static/jquery/jquery.datetimepicker.js"></script>
<script>
    $(document).ready(function () {
      $(".number").keypress(function (e) {
             if (e.which != 8 && e.which != 0 && (e.which < 48 || e.which > 57)) {
               return false;
            }
       });
    });
    function search()
    {
        var bsx = $('#txtBSX').val();
        var st =$('#txtST').val();
        $('.myBody').find('tr').each(
            function(index,val){
                var cp0=$(this).find('td:eq(1)').text();
                var cp1=$(this).find('td:eq(2)').text();
                if (cp0.toUpperCase().includes(bsx.toUpperCase()) && cp1.toUpperCase().includes(st.toUpperCase()) )
                  {
                    $(this).show();
                  }
                  else {
                    $(this).hide();
                 }
            }
        );
    }
    function allcheck(){
        var len = $('#chkall:checked').length;
        //alert(len);
        if(len==0)
        {
             $('.myBody').find('tr').each(
                function(index,val){
                    $(this).find('td:eq(0)').find('input').prop('checked', false);
                    $(this).addClass('grey');
                    //changeFee( $(this).find('td:eq(0)').find('input') );
                    //alert(lenn);
                    //chk.attr('checked', false);
                }
            );
        }
        else{
             $('.myBody').find('tr').each(
                function(index,val){
                    $(this).find('td:eq(0)').find('input').prop('checked', true);
                    $(this).removeClass('grey');
                    //changeFee( $(this).find('td:eq(0)').find('input') );
                    //alert(lenn);
                    //chk.attr('checked', false);
                }
            );
        }
    }
    function lastDate(curDate)
    {
        var lastDay = new Date(curDate.getFullYear(), curDate.getMonth() + 1, 0);
        return lastDay;
    }
    function adddays(curDate, days)
    {
        var tmp_date = new Date(curDate.getFullYear(),curDate.getMonth(),curDate.getDate());
        end_date = tmp_date.setDate(tmp_date.getDate() + days);
        return new Date(end_date);
    }
    function parsedate(datestring)
    {
        var datepart = datestring.split('/');
        var end_date=new Date(datepart[2],datepart[1]-1,datepart[0]);
        return end_date;
    }
    function changeall1(elem){
         var v=$(elem).val();
         if(v!='')
         {

             $('.myBody').find('tr').each(
                    function(index,val){

                        var len = $(this).find('td:eq(0)').find('input:checked').length;
                        if(len>0)
                        {
                            $(this).find('td:eq(5)').find('input').val(v);
                            changeDate($(this).find('td:eq(5)').find('input'));
                            changeFee( $(this).find('td:eq(5)').find('input') );
                        }
                    }
            );

        }
    }
    function changeall2(elem){
        var v=$(elem).val();
         if(v!='')
         {

             $('.myBody').find('tr').each(
                    function(index,val){

                        var len = $(this).find('td:eq(0)').find('input:checked').length;
                        if(len>0)
                        {
                            $(this).find('td:eq(6)').find('select').val(v);
                            changeFee($(this).find('td:eq(6)').find('select') );
                        }
                    }
             );
        }
    }
    function changeall3(elem){

        var v=$(elem).val();
         if(v!='')
         {

             $('.myBody').find('tr').each(
                    function(index,val){

                        var len = $(this).find('td:eq(0)').find('input:checked').length;
                        if(len>0)
                        {
                            $(this).find('td:eq(7)').find('input').val(v);
                            changeFee($(this).find('td:eq(7)').find('input') );

                        }
                    }
             );

        }
    }
    var odd=0;
    var omm=0;
    var oyyyy=0;
    var onumday=0;
    var onummonth=0;
    var ofeepermonth=0;
    var ofee=0;
    var odate=0;
    function changeDate(elem)
    {
        var tr = $(elem).parent('td').parent('tr');
        var stringdate=tr.find('td:eq(5)').find('input').val();
        var expstr=tr.find('td:eq(8)').find('input').val();
        var activedate=parsedate(stringdate);
        var expdate=parsedate(expstr);
        if(activedate<=expdate)
        {
            activedate=adddays(expdate,1);
            var dd=activedate.getDate();
            var mm=activedate.getMonth()+1;
            var yyyy=activedate.getFullYear();
            stringdate=(dd.length==1?"0"+dd:dd)+"/"+(mm.lenght==1?"0"+mm:mm)+"/"+yyyy;
            tr.find('td:eq(5)').find('input').val(stringdate);
        }

    }

    function changeFee(elem){
        $('.bbtt').hide();
        var tr = $(elem).parent('td').parent('tr');
        var len = tr.find('td:eq(0)').find('input:checked').length;
        var fee = parseInt(tr.find('td:eq(11)').find('input').val());
        if(len==0)
        {
            tr.addClass('grey');
            tr.find('td:eq(11)').find('input').val('0');
            tr.find('td:eq(9)').find('input').val('');
            tr.find('td:eq(6)').find('select').val('0');
            tr.find('td:eq(7)').find('input').val('0');
            $('.bbtt').show(1000);
        }
        else
        {
            tr.removeClass('grey');
            dn=tr.find('td:eq(7)').find('input').val();
            if(dn=='')
                dn='0';
            var daynum=parseInt(dn);
            var monthnum=parseInt(tr.find('td:eq(6)').find('select').val());
            var feepermonth=parseInt(tr.find('td:eq(10)').find('input').val());
            if(daynum==0 && monthnum==0)
            {
                tr.find('td:eq(11)').find('input').val('0');
                tr.find('td:eq(9)').find('input').val('');
                $('.bbtt').show(1000);
            }
            else
            {
                var stringdate=tr.find('td:eq(5)').find('input').val();
                var activedate=parsedate(stringdate);
                var dd=activedate.getDate();
                var mm=activedate.getMonth()+1;
                var yyyy=activedate.getFullYear();
                if(dd==odd && mm==omm && yyyy==oyyyy && onumday==daynum && onummonth==monthnum && ofeepermonth==feepermonth)
                {
                    tr.find('td:eq(11)').find('input').val(ofee);
                    tr.find('td:eq(9)').find('input').val(odate);
                    $('.bbtt').show(1000);
                }
                else
                {
                    $.ajax({
                        type:"GET",
                        url: "/get/newexpireddate/"+dd+"/"+mm+"/"+yyyy+"/"+monthnum+"/"+daynum+"/"+feepermonth+"/",
                        success: function( data )
                        {
                            //alert('sucess');
                            //console.log(data);
                            strp=data.split('@');
                            odd=dd;
                            omm=mm;
                            oyyyy=yyyy;
                            onummonth=monthnum;
                            onumday=daynum;
                            ofeepermonth=feepermonth;
                            ofee=strp[1];
                            odate=strp[0];
                            tr.find('td:eq(11)').find('input').val(ofee);
                            tr.find('td:eq(9)').find('input').val(odate);

                        },
                        error:function(err)
                        {
                            tr.find('td:eq(11)').find('input').val('0');
                            tr.find('td:eq(9)').find('input').val('');

                            //alert('err');
                            //console.log(err);
                        }
                     }).complete(function(){$('.bbtt').show(1000);});
                 }
            }
        }
    }
    function settotalfee()
    {
        totalfee=0;
        var tr = $('.myBody').find('tr');
        $('.myBody').find('tr').each(
            function(index,val){
                var len = $(this).find('td:eq(0)').find('input:checked').length;
                var fee=$(this).find('td:eq(11)').find('input').val();
                if(len > 0 && fee!='0')
                {
                    totalfee=totalfee+parseInt(fee);
                }
            }
        );
        $('#txttotalfee').val(totalfee);
    }
    $('.myBody').hover(
        function(){
             settotalfee();

        }
    );
    $('#txtAjax').hover(function(){
        settotalfee();
    });
    $('#txtAjax').click(function(){
        $('.loading').show();
        var ids = [];
        var olddays=[];
        var newdays=[];
        var fees=[];
        var lvfees=[];
        var tr = $('.myBody').find('tr');
        $('.myBody').find('tr').each(
            function(index,val){
                $(this).show();
                var len = $(this).find('td:eq(0)').find('input:checked').length;
                var fee=$(this).find('td:eq(11)').find('input').val();
                if(len > 0 )//&& fee!='0')
                {
                    ids.push($(this).find('td:eq(0)').find('input:hidden').val());
                    olddays.push($(this).find('td:eq(5)').find('input').val());
                    newdays.push($(this).find('td:eq(9)').find('input').val());
                    fees.push(fee);
                    lvfees.push($(this).find('td:eq(10)').find('input').val());
                }
            }
        );
        //console.log(ids);
        if(ids.length>0)
        {
        $.ajax({
                 type:"POST",
                 url:"/post/renewalregistry/",
                 data: {
                        'customer': $('#hdfCus').val(), // from form
                        'staff':$('#hdfUser').val(),
                        'totalfee':$('#txttotalfee').val(),
                        'note':$('#txtNote').val(),
                        'ids[]':ids,
                        'olddays[]':olddays,
                        'newdays[]':newdays,
                        'fees[]':fees,
                        'lvfees[]':lvfees
                        },
                 success: function(data){
                     if(data=="not excute")
                         alert('Không thể thực thi tại server. Vui lòng thử lại');
                     else
                     {
                         hr="/pdf/ticket-payment/"+data+"/";
                         alert('Gia hạn thành công');
                         console.log(data);
                         window.location.href = hr;
                     }
                 },
                 error:function(err)
                 {
                    alert('error');
                    console.log(err);
                 }
            }).complete(function(){$('.loading').hide();});
        }
        else
        {
            $('.loading').hide();
        }
        return false;
    });
    jQuery('.activedate').bind("mousewheel", function () {
                if ($.browser.webkit === true) {
                    return false;
                }
            });
    jQuery('.activedate').datetimepicker({
        format:'d/m/Y',
        timepicker:false,
        lang:'vi',
        i18n:{
            vi:{
                months:[
                    'Tháng Một','Tháng Hai','Tháng Ba','Tháng Tư',
                    'Tháng Năm','Tháng Sáu','Tháng Bảy','Tháng Tám',
                    'Tháng Chín','Tháng Mười','Tháng Mười Một','Tháng Mười Hai',
                    ],
                dayOfWeek:[
                    "Chủ Nhật", "Hai", "Ba", "Tư",
                    "Năm", "Sáu", "Bảy.",
                ]
            }
        }
//        onShow:function( ct ){
//            this.setOptions({
//                maxDate:jQuery('#datetimepicker_end').val()?jQuery('#datetimepicker_end').val():false
//            })
//        }
    });


</script>

<script>
    $(document).ready(function () {
        var table = $('#datatable').dataTable( {
            "order": [[0, "asc"]],
            "iDisplayLength" : 50,
            "oLanguage": {
                "sProcessing":   "Đang xử lý...",
                "sLengthMenu":   "Xem _MENU_ mục",
                "sZeroRecords":  "Không tìm thấy dòng nào phù hợp",
                "sInfo":         "Đang xem _START_ đến _END_ trong tổng số _TOTAL_ mục",
                "sInfoEmpty":    "Đang xem 0 đến 0 trong tổng số 0 mục",
                "sInfoFiltered": "(được lọc từ _MAX_ mục)",
                "sInfoPostFix":  "",
                "sSearch":       "",
                "sUrl":          "",
                "oPaginate": {
                "sFirst":    "Đầu",
                 "sPrevious": "Trước ",
                 "sNext":     " Sau",
                 "sLast":     "Cuối"
                 }
            }
        } );
    });

    var $j = jQuery.noConflict();
    $j(function() {
        $j("#card_label").autocomplete({
            source: "/admin/get_card_labels"
            });
        });
</script>
<script>
    $(document).ready(function () {
       var startdate = $('#datetimepicker_start')
    });
</script>

{% endblock %}
